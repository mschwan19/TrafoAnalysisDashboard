<!DOCTYPE html>
<html>
<head>
    <title>Solar Potential Analysis</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
     
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #container { display: flex; height: 100vh; width: 100%; }
        
        #sidebar {
            width: 350px;
            min-width: 350px;
            background-color: #f8f9fa;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: transform 0.3s ease-out;
        }
        
        #map {
            flex-grow: 1;
            height: 100%;
        }
        
        .sidebar-header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .sidebar-content {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
        }
        
        .info-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 5px solid #ccc;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .score-indicator {
            display: inline-block;
            width: 100%;
            height: 20px;
            background: #eee;
            border-radius: 10px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .score-bar {
            height: 100%;
            background: #2ecc71;
            width: 0%;
            transition: width 0.5s ease-in-out;
        }
        
        .instruction {
            color: #7f8c8d;
            font-style: italic;
            text-align: center;
            margin-top: 50px;
        }

        /* ANPASSUNGEN: LEGEND */
        
        /* Legende kleiner machen und rechts unten positionieren */
        .legend {
            background: white;
            padding: 8px; 
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 11px;
            /* WICHTIG: Definiert den Randabstand, wenn die Legende rechts unten platziert wird */
            margin-right: 10px; 
            margin-bottom: 10px;
        }
        .legend-item { margin-bottom: 3px; }
        .color-box { width: 15px; height: 15px; margin-right: 5px; opacity: 0.7; }


        /* Mobile Sidebar Toggle Button */
        #sidebar-toggle {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1001; 
            background-color: #2c3e50;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: none;
        }

        /* Media Query für kleine Bildschirme (max. 768px Breite) */
        @media (max-width: 768px) {
            #sidebar-toggle {
                display: block;
            }

            #sidebar {
                position: absolute;
                top: 0;
                left: 0;
                height: 100%;
                width: 80vw;
                min-width: 0;
                transform: translateX(-100%);
            }
            
            #sidebar.open {
                transform: translateX(0);
            }

            #container {
                display: block;
            }

            #map {
                width: 100%;
            }
            
            /* Zoom-Kontrolle auf Handys etwas nach unten verschieben, damit sie nicht mit dem Seiten-Toggle kollidiert */
            /* Leaflet topright Container ist standardmäßig 10px vom Rand entfernt */
             .leaflet-top.leaflet-right {
                top: 50px;
            }
            
            /* Legende auf Handys anpassen */
            .leaflet-bottom.leaflet-right {
                bottom: 20px; /* Fügt einen Abstand zur unteren Kante hinzu */
                right: 10px; /* Standardabstand von Leaflet zur rechten Kante */
            }
        }
    </style>
</head>
<body>

<div id="container">
    
    <button id="sidebar-toggle" title="Sidebar umschalten">
        <i class="fas fa-bars"></i>
    </button>

    <div id="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-solar-panel"></i> Solar Analyse</h2>
        </div>
        <div class="sidebar-content" id="sidebar-info">
            <div class="instruction">
                <p>Klicken Sie auf einen Trafo-Sektor (Kreis) oder einen Marker auf der Karte, um detaillierte Informationen anzuzeigen.</p>
            </div>
        </div>
    </div>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
 integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
 crossorigin=""></script>

<script>
    
    // Funktion zum Umschalten der Sidebar
    function toggleSidebar() {
        var sidebar = document.getElementById('sidebar');
        var icon = document.getElementById('sidebar-toggle').querySelector('i');
        
        sidebar.classList.toggle('open');
        
        // Icon ändern
        if (sidebar.classList.contains('open')) {
            icon.classList.replace('fa-bars', 'fa-times'); // Zu Schließen-Icon wechseln
        } else {
            icon.classList.replace('fa-times', 'fa-bars'); // Zu Menü-Icon wechseln
        }
    }
    
    // Event Listener für den Button
    document.getElementById('sidebar-toggle').addEventListener('click', toggleSidebar);

    // Initialisierung des Maps: Standard-ZoomControl deaktivieren
    var map = L.map('map', {zoomControl: false}).setView([49.044, 9.197], 14);
    
    // Zoom-Control manuell rechts oben hinzufügen
    L.control.zoom({position: 'topright'}).addTo(map);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Data from Python 
    var trafos = [{"id": "03TS0001", "lat": 49.041478013975414, "lon": 9.193368795251228, "panels_in_range": 10, "score": 11.111111111111116, "color": "#ff3800ff"}, {"id": "03TS0008", "lat": 49.04521152003828, "lon": 9.192621327124252, "panels_in_range": 5, "score": 66.66666666666667, "color": "#aad500ff"}, {"id": "03TS0013", "lat": 49.04400890616599, "lon": 9.197936614288833, "panels_in_range": 5, "score": 66.66666666666667, "color": "#aad500ff"}, {"id": "03TS0021", "lat": 49.042107918011936, "lon": 9.19712324946646, "panels_in_range": 11, "score": 0.0, "color": "#ff0000ff"}, {"id": "03TS0023", "lat": 49.04262581068064, "lon": 9.203027866778873, "panels_in_range": 2, "score": 100.0, "color": "#008000ff"}, {"id": "03TS0026", "lat": 49.04667746829518, "lon": 9.197129953353837, "panels_in_range": 3, "score": 88.88888888888889, "color": "#389c00ff"}, {"id": "03TS0030", "lat": 49.042104535405734, "lon": 9.20003015594376, "panels_in_range": 9, "score": 22.22222222222222, "color": "#ff7100ff"}, {"id": "03TS0031", "lat": 49.046724232462914, "lon": 9.196240081830293, "panels_in_range": 5, "score": 66.66666666666667, "color": "#aad500ff"}];
    var panels = [{"id": 0, "lat": 49.04373695792584, "lon": 9.193292733453053}, {"id": 1, "lat": 49.04177495342609, "lon": 9.199427251414642}, {"id": 2, "lat": 49.04179537712595, "lon": 9.19942876536927}, {"id": 3, "lat": 49.04441288562365, "lon": 9.200935453080742}, {"id": 4, "lat": 49.04866995833716, "lon": 9.193835836231719}, {"id": 5, "lat": 49.04408246014071, "lon": 9.199699134477433}, {"id": 6, "lat": 49.041757589810715, "lon": 9.196735521928169}, {"id": 7, "lat": 49.04190135611931, "lon": 9.195127713600446}, {"id": 8, "lat": 49.041668456771525, "lon": 9.194279583861778}, {"id": 9, "lat": 49.04174699624677, "lon": 9.194267190945787}, {"id": 10, "lat": 49.042375228547996, "lon": 9.19920930634763}, {"id": 11, "lat": 49.04599268097206, "lon": 9.197635244450051}, {"id": 12, "lat": 49.041936338117615, "lon": 9.195073154616779}, {"id": 13, "lat": 49.042432354018906, "lon": 9.200674355910358}, {"id": 14, "lat": 49.04357223073323, "lon": 9.197496502195131}, {"id": 15, "lat": 49.042495530541196, "lon": 9.19288772588457}, {"id": 16, "lat": 49.04477975187331, "lon": 9.195302920672756}, {"id": 17, "lat": 49.042490439185535, "lon": 9.192782911035351}, {"id": 18, "lat": 49.04275955847102, "lon": 9.194249487353689}, {"id": 19, "lat": 49.04238651524895, "lon": 9.199024769230725}, {"id": 20, "lat": 49.042371497776614, "lon": 9.200504625878361}, {"id": 21, "lat": 49.04435535054973, "lon": 9.197708122108047}, {"id": 22, "lat": 49.04232792574771, "lon": 9.19921238019322}, {"id": 23, "lat": 49.045914229015814, "lon": 9.197521173465455}, {"id": 24, "lat": 49.04462855348626, "lon": 9.194832874121415}, {"id": 25, "lat": 49.04818912906185, "lon": 9.192722842175739}, {"id": 26, "lat": 49.04275497975782, "lon": 9.193982236764368}, {"id": 27, "lat": 49.042752979824265, "lon": 9.193982236764368}, {"id": 28, "lat": 49.04664308334859, "lon": 9.19365390146618}, {"id": 29, "lat": 49.04462855348626, "lon": 9.194832874121415}, {"id": 30, "lat": 49.04838896811754, "lon": 9.191638857912093}, {"id": 31, "lat": 49.04644206880403, "lon": 9.19402451577088}, {"id": 32, "lat": 49.041750361950186, "lon": 9.196441535619972}, {"id": 33, "lat": 49.04376211268634, "lon": 9.195720015288854}, {"id": 34, "lat": 49.04170648046952, "lon": 9.196645480776011}, {"id": 35, "lat": 49.04227422143816, "lon": 9.200173253489558}, {"id": 36, "lat": 49.04185149249918, "lon": 9.200045125336398}, {"id": 37, "lat": 49.042141498184925, "lon": 9.19317027258078}, {"id": 38, "lat": 49.04595890844444, "lon": 9.197518323665136}, {"id": 39, "lat": 49.04917984554982, "lon": 9.195333880226551}];

    // Add Panels
    panels.forEach(function(panel) {
        L.circleMarker([panel.lat, panel.lon], {
            radius: 4,
            fillColor: "#3498db",
            color: "#2980b9",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
        }).addTo(map).bindPopup("Solar Panel ID: " + panel.id);
    });

    // Function to update Sidebar
    function updateSidebar(trafo) {
        var sidebar = document.getElementById('sidebar-info');
        
        var scoreColor = trafo.color; 

        var html = `
            <div class="info-card" style="border-left-color: ${scoreColor}">
                <div class="stat-label">Trafo ID</div>
                <div class="stat-value">${trafo.id}</div>
            </div>

            <div class="info-card" style="border-left-color: ${scoreColor}">
                <div class="stat-label">Solarpanele (Radius 200m)</div>
                <div class="stat-value">${trafo.panels_in_range}</div>
            </div>

            <div class="info-card" style="border-left-color: ${scoreColor}">
                <div class="stat-label">Aquise-Score</div>
                <div class="stat-value">${trafo.score.toFixed(1)}%</div>
                <div class="score-indicator">
                    <div class="score-bar" style="width: ${trafo.score}%; background-color: ${scoreColor};"></div>
                </div>
                <small style="color: #666; display: block; margin-top: 5px;">
                    ${trafo.score > 80 ? 'Sehr hohes Potenzial' : (trafo.score > 40 ? 'Mittleres Potenzial' : 'Geringes Potenzial')}
                </small>
            </div>
            
            <div class="info-card">
                <div class="stat-label">Standort</div>
                <div>Lat: ${trafo.lat.toFixed(4)}</div>
                <div>Lon: ${trafo.lon.toFixed(4)}</div>
            </div>
        `;
        sidebar.innerHTML = html;
        
        // Mobile: Sidebar automatisch öffnen, wenn ein Trafo angeklickt wird
        if (window.innerWidth <= 768) {
            document.getElementById('sidebar').classList.add('open');
            document.getElementById('sidebar-toggle').querySelector('i').classList.replace('fa-bars', 'fa-times');
        }
    }

    // Add Trafos
    trafos.forEach(function(trafo) {
        // Circle - The main visual element for the radius
        var circle = L.circle([trafo.lat, trafo.lon], {
            color: trafo.color,
            fillColor: trafo.color,
            fillOpacity: 0.15,
            weight: 2,
            radius: 200
        }).addTo(map);
        
        // Click handler for Circle
        circle.on('click', function() {
            updateSidebar(trafo);
        });

        // Icon Marker
        var icon = L.divIcon({
            className: 'custom-div-icon',
            html: '<div style="width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; font-size: 24px; color: black; text-shadow: 0 0 3px white;"><i class="fas fa-bolt"></i></div>',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        var marker = L.marker([trafo.lat, trafo.lon], {
            icon: icon
        }).addTo(map);

        // Click handler for Marker
        marker.on('click', function() {
            updateSidebar(trafo);
            map.flyTo([trafo.lat, trafo.lon], 15);
        });
    });
    
    // Legende zur Karte hinzufügen (Position: bottomright durch JS festgelegt)
    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'legend');
        div.innerHTML += '<div style="font-weight:bold; margin-bottom:5px;">Legende</div>';
        div.innerHTML += '<div class="legend-item"><div class="color-box" style="display: flex; justify-content: center; align-items: center; width: 15px; height: 15px;"><i class="fas fa-bolt" style="font-size: 10px;"></i></div>Transformator</div>';
        div.innerHTML += '<div class="legend-item"><div class="color-box" style="background: green;"></div>Hohes Potenzial (Wenig Auslastung)</div>';
        div.innerHTML += '<div class="legend-item"><div class="color-box" style="background: yellow;"></div>Mittleres Potenzial</div>';
        div.innerHTML += '<div class="legend-item"><div class="color-box" style="background: red;"></div>Niedriges Potenzial (Viel Auslastung)</div>';
        div.innerHTML += '<div class="legend-item"><div class="color-box" style="background: blue; border-radius:50%;"></div>Solarpanel</div>';
        return div;
    };
    legend.addTo(map);

</script>
</body>
</html>
